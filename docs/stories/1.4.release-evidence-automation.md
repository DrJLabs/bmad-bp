# Story 1.4: Automate Release Evidence Capture & Post-Change Validation

## Status

- Done

## Story

**As the** release maintainer for BMAD,
**I want** to automate release evidence capture and exercise the semantic-release pipeline after a real version bump,
**so that** audit artefacts remain current and the release governance focused epic can close its outstanding validation items.

## Acceptance Criteria

1. Implement an automation command (e.g., `npm run release:evidence`) that downloads the latest dry-run output, Release workflow logs, skip/permissions artefacts, and stores them under `docs/bmad/focused-epics/release-governance/evidence/` with timestamped filenames to eliminate manual retention risk. The command must accept an explicit GitHub Actions run ID (defaulting to latest when omitted) and rely on GitHub CLI subcommands for log and artifact retrieval before writing timestamped copies. [Source: docs/qa/assessments/release-governance.story-1.3-risk-20250925.md#Residual-Risks][Source: docs/qa/assessments/release-governance.story-1.3-test-design-20250925.md#Follow-Up-Tasks][Source: docs/release-automation.md#evidence-capture-checklist-story-1-1-4][Source: https://cli.github.com/manual/gh_run_download][Source: https://cli.github.com/manual/gh_run_view]
2. Update `docs/release-automation.md`, `docs/versioning-and-releases.md`, and the Story 1 change log so maintainers are instructed to run the automation immediately after each release workflow run, including how to supply the run ID and where evidence files are persisted. [Source: docs/release-automation.md#evidence-capture-checklist-story-1-1-4][Source: docs/versioning-and-releases.md#-automated-release-workflow][Source: docs/bmad/focused-epics/release-governance/story-1.md#Follow-Up-Tasks]
3. Produce a release-worthy change on `main`, trigger `.github/workflows/release.yaml`, run the automation, and record the resulting run ID, release URL, tarball status, and evidence paths in Story 1’s change log to close the open validation follow-up. [Source: docs/qa/assessments/release-governance.story-1.3-trace-20250925.md#Follow-Ups][Source: docs/qa/assessments/release-governance.story-1.3-nfr-20250925.md#Recommendations][Source: docs/bmad/focused-epics/release-governance/story-1.md#Follow-Up-Tasks]

## Tasks / Subtasks

- [x] Design an automated evidence collection script (Node or shell) that wraps `gh run view`, `gh run download`, and `gh api` to fetch logs/artifacts, validates inputs (explicit run ID, workflow name fallback), and emits timestamped files into the evidence directory. [Source: docs/qa/assessments/release-governance.story-1.3-test-design-20250925.md#Follow-Up-Tasks][Source: docs/release-automation.md#evidence-capture-checklist-story-1-1-4][Source: https://cli.github.com/manual/gh_run_view][Source: https://cli.github.com/manual/gh_run_download]
  - [x] Add unit coverage or smoke tests validating timestamped output paths and file naming conventions for the script. [Source: docs/qa/assessments/release-governance.story-1.3-test-design-20250925.md#Test-Scenarios]
- [x] Implement safeguards that fail fast with actionable messaging when GitHub CLI returns empty logs or missing artifacts (common CLI edge cases) and document retry guidance. [Source: docs/qa/assessments/release-governance.story-1.3-risk-20250925.md#Mitigations][Source: https://cli.github.com/manual/gh_run_view]
- [x] Wire the script into `package.json` (e.g., `release:evidence`) and document required inputs such as run ID, evidence type toggles, and output structure. [Source: docs/qa/assessments/release-governance.story-1.3-risk-20250925.md#Mitigations]
- [x] Update release documentation and Story 1 change log with the new automation steps, replacing manual download guidance. [Source: docs/release-automation.md#evidence-capture-checklist-story-1-1-4][Source: docs/versioning-and-releases.md#-automated-release-workflow]
- [x] Merge or coordinate a release-worthy change (e.g., `fix:` or `feat:`) so semantic-release produces a new version, dispatch the Release workflow, run the automation, and attach outputs plus run metadata to Story 1’s Evidence++ table. [Source: docs/qa/assessments/release-governance.story-1.3-trace-20250925.md#Follow-Ups][Source: docs/bmad/focused-epics/release-governance/story-1.md#Follow-Up-Tasks]

## Dev Notes

- **Previous Story Insights:** Story 1.3 closed documentation cross-links and populated evidence placeholders but still relied on manual log downloads and recorded a skipped release run; automation must keep those artefacts fresh. [Source: docs/stories/1.3.release-evidence-audit-closure.md#Dev-Notes]
- **Evidence Automation Gap:** Risk and test assessments call for scripting evidence archiving to mitigate 90-day retention limits and reduce manual toil. [Source: docs/qa/assessments/release-governance.story-1.3-risk-20250925.md#Residual-Risks][Source: docs/qa/assessments/release-governance.story-1.3-test-design-20250925.md#Follow-Up-Tasks]
- **Release Workflow Touchpoints:** The Release workflow already generates dry-run, skip, and permissions logs that the runbook expects maintainers to store manually; automation must respect existing file locations under `docs/bmad/focused-epics/release-governance/evidence/`. [Source: docs/release-automation.md#evidence-capture-checklist-story-1-1-4]
- **Automation Command:** Use `npm run release:evidence` (optionally providing `--run-id`) to capture gh auth status, workflow metadata/logs, and refreshed dry-run output in timestamped evidence directories. [Source: package.json][Source: docs/versioning-and-releases.md#-automated-release-workflow]
- **Project Structure Notes:** `.bmad-core/core-config.yaml` references sharded architecture files under `docs/architecture/`, but those shards do not exist; no additional architecture constraints are available beyond existing release docs. [Source: .bmad-core/core-config.yaml][Source: docs/stories/1.3.release-evidence-audit-closure.md#Dev-Notes]
- **Testing Requirements:** Follow the Story 1.3 test design scenarios (REL1.3-T1–T3) as regression coverage, supplementing with new automation checks to ensure evidence capture remains audit-ready. [Source: docs/qa/assessments/release-governance.story-1.3-test-design-20250925.md#Test-Scenarios]

## Testing

- `REL1.4-T1` — Unit-test or dry-run the evidence automation script with mocked GitHub responses to confirm timestamped files are written to `docs/bmad/focused-epics/release-governance/evidence/` and that run IDs are validated. [Source: docs/qa/assessments/release-governance.story-1.3-test-design-20250925.md#Test-Scenarios]
- `REL1.4-T2` — After merging a release-worthy commit, verify the Release workflow produces a non-skipped run, then run the automation command and validate the new run ID, release URL, and tarball status are appended to Story 1 change log. Include assertions that the CLI outputs are persisted even if the workflow skipped individual jobs. [Source: docs/qa/assessments/release-governance.story-1.3-trace-20250925.md#Follow-Ups][Source: https://cli.github.com/manual/gh_run_view]
- `REL1.4-T3` — Confirm updated documentation anchors and instructions reference the automation command and evidence directory, replacing the prior manual checklist. [Source: docs/release-automation.md#evidence-capture-checklist-story-1-1-4][Source: docs/versioning-and-releases.md#-automated-release-workflow]
- `REL1.4-T4` — Exercise a negative-path run where the CLI cannot fetch logs/artifacts, confirm the script emits actionable errors, and document manual remediation steps. [Source: docs/qa/assessments/release-governance.story-1.3-risk-20250925.md#Mitigations][Source: https://cli.github.com/manual/gh_run_view]
- `REL1.4-T5` — Verify documentation instructs maintainers on retention checks and artifact pruning, ensuring anchors point to the updated checklist and Story 1 change log guidance. [Source: docs/release-automation.md#evidence-capture-checklist-story-1-1-4][Source: docs/versioning-and-releases.md#-automated-release-workflow]
- `REL1.4-T6` — Run the automation command twice in rapid succession to confirm timestamp collision handling prevents overwriting evidence. [Source: docs/qa/assessments/release-governance.story-1.4-test-design-20250926.md#Test-Scenarios]
- `REL1.4-T7` — Validate the repository or organization retention policy matches documented expectations and that evidence pruning scripts respect the configured window. [Source: docs/qa/assessments/release-governance.story-1.4-test-design-20250926.md#Test-Scenarios][Source: https://docs.github.com/en/organizations/managing-organization-settings/configuring-the-retention-period-for-github-actions-artifacts-and-logs-in-your-organization]

## Change Log

| Date       | Version | Description                        | Author |
| ---------- | ------- | ---------------------------------- | ------ |
| 2025-09-25 | 0.1.0   | Initial draft of automation story. | Bob    |

## Dev Agent Record

### Agent Model Used

Codex GPT-5 (dev)

### Debug Log References

- docs/bmad/focused-epics/release-governance/evidence/release-run-18024216996-20250926T040000Z/gh-auth-status-20250926T040000Z.txt
- docs/bmad/focused-epics/release-governance/evidence/release-run-18024216996-20250926T040000Z/release-run-18024216996.log
- docs/bmad/focused-epics/release-governance/evidence/release-run-18024216996-20250926T040000Z/release-run-18024216996-metadata.json

### Completion Notes List

- Rebased onto `main` post-merge and resolved documentation conflicts.
- Executed `npm run release:evidence -- --run-id 18024216996 --skip-dry-run` to capture live release evidence and gh auth snapshot.
- Updated Story 1 change log with `v1.1.0` release metadata and archived evidence directory.
- Refreshed QA artifacts (trace, NFR, review, gate) to reflect full coverage and PASS status.
- Re-ran reviewer and formatting checks after evidence capture.
- Marked Story 1.4 as complete with gate PASS and PO validation satisfied.

### File List

- docs/bmad/focused-epics/release-governance/story-1.md
- docs/release-automation.md
- docs/versioning-and-releases.md
- docs/bmad/issues/release-governance-duplicate-content.md
- docs/qa/assessments/release-governance.story-1.4-\*.md
- docs/qa/gates/release-governance.story-1.4-automate-release-evidence-capture-post-change-validation.yml
- docs/stories/1.4.release-evidence-automation.md
- tools/release/capture-release-evidence.js
- tools/release/**tests**/capture-release-evidence.test.js

## QA Results

- Risk profile: docs/qa/assessments/release-governance.story-1.4-risk-20250926.md (Score 32/100 – Medium). Remaining attention on documentation link automation and retention policy follow-up.
- Test design: docs/qa/assessments/release-governance.story-1.4-test-design-20250926.md (All ACs fully covered).

### Review Date: 2025-09-26

### Reviewed By: Quinn (Test Architect)

#### Code Quality & Testability

- `tools/release/capture-release-evidence.js`: Helpers validated; added skip flag logging and stricter error handling; live run 18024216996 confirmed workflow.
- `tools/release/__tests__/capture-release-evidence.test.js`: Confirms evidence path shaping; consider augmenting with mocked CLI integration tests.
- Documentation (`docs/release-automation.md`, `docs/versioning-and-releases.md`) now instructs maintainers to run the automation command and check retention windows.

#### Tests & Automation

- `npm run release:evidence:test`
- `npm run release:evidence -- --run-id 18024216996 --skip-dry-run`
- `npm run reviewer:preflight`
- `npm run reviewer:scan` (latest artifacts in `artifacts/reviewer/20250926T040820Z`, Semgrep=0; duplicates limited to legacy docs, tracked via `docs/bmad/issues/release-governance-duplicate-content.md`).
- `npm run format:check`

#### Coverage & NFR References

- Trace matrix: docs/qa/assessments/release-governance.story-1.4-trace-20250926.md (All ACs fully covered).
- NFR assessment: docs/qa/assessments/release-governance.story-1.4-nfr-20250926.md (All core NFRs PASS after live release run).

#### Follow-Ups / Recommendations

- Add automated link check for updated release documentation anchors.
- Evaluate mocked GH CLI integration test to cover failure modes without real credentials.

### Gate Status

Gate: PASS → docs/qa/gates/release-governance.story-1.4-automate-release-evidence-capture-post-change-validation.yml

## 🔬 Research & Validation Log (2025-09-26)

- **Researcher:** Dr. Evelyn Reed
- **Active Mode:** solo
- **Primary Artifact:** docs/stories/1.4.release-evidence-automation.md
- **Summary:** Validated that Story 1.4 must formalize a GitHub CLI-driven evidence automation workflow, document fast-fail guidance, and ensure a non-skipped semantic-release run exercises the process end-to-end. Added safeguards, testing, and documentation hooks so the focused epic can close remaining audit items.

### Findings & Actions

| Priority | Area       | Recommended Change                                                                                                             | Owner / Reviewer | Confidence | Mode | Controls   | Evidence Location                                               | Sources                                                                                                                                          |
| -------- | ---------- | ------------------------------------------------------------------------------------------------------------------------------ | ---------------- | ---------- | ---- | ---------- | --------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| High     | Automation | Specify GitHub CLI-driven evidence capture (run ID input, error handling, timestamped outputs) and expand negative-path tests. | Dev Agent / PO   | High       | solo | SOC2 CC8.1 | docs/bmad/focused-epics/release-governance/evidence/ (post-run) | [GitHub CLI gh run view](https://cli.github.com/manual/gh_run_view), [GitHub CLI gh run download](https://cli.github.com/manual/gh_run_download) |

### Tooling Guidance

- **FOSS-first Recommendation:** Use GitHub CLI (`gh run view`, `gh run download`) with semantic-release CLI dry runs to collect and verify evidence.citeturn1search0turn1search4turn1search6
- **Paid Option (if required):** None — GitHub CLI and semantic-release cover requirements.
- **Automation / Scripts:** Provide `npm run release:evidence -- --run-id <id>` wrapper calling `gh run view --log` and `gh run download --name evidence --dir docs/bmad/focused-epics/release-governance/evidence/$(date +%Y%m%dT%H%M%SZ)`.

### Risk & Compliance Notes

- **Residual Risks:** GitHub CLI calls still depend on retention windows; surface early warnings when artifacts are missing.
- **Compliance / Control Mapping:** Supports SOC2 CC8.1 change-management evidence capture by automating log retention.
- **Monitoring / Observability:** Expose automation command results in Story 1 change log; optionally emit GitHub Actions summary for quick review.
- **Rollback / Contingency:** Provide manual fallback instructions (download logs from Actions UI) when CLI automation fails.

### Follow-Up Tasks

- [ ] Prototype `release:evidence` script with mockable wrapper around GitHub CLI — Owner: Dev Agent, Due: 2025-09-30.
- [ ] Update Story 1 change log template entry once first automated run succeeds — Owner: Release Maintainer, Due: Post-release run.

### Source Appendix

1. gh run view — GitHub CLI Docs (Accessed 2025-09-26)citeturn1search0
2. gh run download — GitHub CLI Docs (Accessed 2025-09-26)citeturn1search4
3. Configuration (semantic-release) — semantic-release Docs (Accessed 2025-09-26)citeturn1search6
